#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import os
import sys
import time
import requests
import pandas as pd
from tqdm import tqdm

SUPPORTED_LANGS = ["hindi", "telugu", "bangla", "malayalam", "tamil"]

### ==========================================================
###  FEW-SHOT EXAMPLES (same as your GPT-4 script)
### ==========================================================

# -------- FEWSHOT EXAMPLES --------
HINDI_FEWSHOT = [
    ("शिक्षा क्या है?", "शिक्षा क्या है?"),
    ("किसी भी कार्य को सीख लेने की क्रिया को शिक्षा कहा जा सकता है।", "किसी भी कार्य को सीख लेने की क्रिया को शिक्षा कहा जा सकता है।"),
    ("ये केवल किताबी ज्ञान अर्जन तक ही सिमित नहीं है।", "ये केवल किताबी ज्ञान अर्जन तक ही सीमित नहीं है।"),
    ("यह कई विभागों में बांटा जा सकता है।", "यह कई विभागों में बांटा जा सकता है।"),
    ("\"जैसे - व्यावहारिक शिक्षा, किताबी शिक्षा अथवा अध्यामित्क शिक्षा\"", "जैसे - व्यावहारिक शिक्षा, किताबी शिक्षा अथवा आध्यात्मिक शिक्षा ।"),
    ("किताबी शिक्षा- ये वो ज्ञान होता है जो हम किताबों  के माध्यम से अर्जित करते हैं।", "किताबी शिक्षा- ये वो ज्ञान होता है जो हम किताबों  के माध्यम से अर्जित करते हैं।"),
    ("पहले  विद्यालय की जगह लोग गुरुकुल में पढ़ा करते थे।", "पहले  विद्यालय की जगह लोग गुरुकुल में पढ़ा करते थे।"),
    ("वहाँ  अचार्य होते थे शिक्षक के स्थान पे।", "वहाँ  अचार्य होते थे शिक्षक के स्थान पर।"),
    ("व्यावहारिक शिक्षा- ये वो ज्ञान है जो शिशु से लेकर वृद्धावस्था तक हमारे साथ रहता है।", "व्यावहारिक शिक्षा- ये वो ज्ञान है जो शिशु से लेकर वृद्धावस्था तक हमारे साथ रहता है।"),
    ("ये शिक्षा आप जीवन भर अर्जित करते है।", "ये शिक्षा आप जीवन भर अर्जित करते हैं।"),
]

BANGLA_FEWSHOT = [
    ("এই পুস্তকটি খুবই চমকপ্রদ।", "এই পুস্তকটি খুবই চমকপ্রদ।"),
    ("এতে “ধনিক কৃষক অথবা ‘ৰণিক কৃষক” এইভাবেই স্পষ্টত যাদের অ্যাখ্যা দেওয়া হয়েছে এদের জন্মবৃত্তান্ত আলোচনা করা হয়েছে এবং যে ছোট কৃষক শুধুমাত্র নিজের ভরণ-পোষণের জন্য কাজ করে তার তুলনায় এই নূতন কৃষক আত্মগরিমা ফলিয়েছেন।",
     "এতে “ধনিক কৃষক অথবা ‘ৰণিক কৃষক” এইভাবেই স্পষ্টত যাদের অ্যাখ্যা দেওয়া হয়েছে এদের জন্মবৃত্তান্ত আলোচনা করা হয়েছে এবং যে ছোট কৃষক শুধুমাত্র নিজের ভরণ-পোষণের জন্য কাজ করে তার তুলনায় এই নূতন কৃষক আত্মগরিমা ফলিয়েছেন।"),
    ("ধনিকের শেষ পর্যন্ত শ্রেণীগতভাবে কায়িক পরিশ্রমের প্রয়োজন থেকে সম্পূর্ণ মুক্ত হন।",
     "ধনিকের শেষ পর্যন্ত শ্রেণীগতভাবে কায়িক পরিশ্রমের প্রয়োজন থেকে সম্পূর্ণ মুক্ত হন।"),
    ("মার্কস ও এঙ্গেলস কথাটা ব্যবহার করেছিলেন শহরবাসী পেটি বুর্জোয়ার প্রতিক্রিয়াশীল অংশগুলির অর্থে।",
     "মার্কস ও এঙ্গেলস কথাটা ব্যবহার করেছিলেন শহরবাসী পেটি বুর্জোয়ার প্রতিক্রিয়াশীল অংশগুলির অর্থে।"),
    ("\"অন্য শব পণ্যের মূল্যের মত, তার মূল্য নির্ধারিত হয় তার উৎপাদনের জন্য প্রয়োজনীয় শ্রমের দ্বারা।\"",
     "অন্য সব পণ্যের মূল্যের মত, তার মূল্য নির্ধারিত হয় তার উৎপাদনের জন্য প্রয়োজনীয় শ্রমের দ্বারা।"),
    ("এই সঙ্গে স্বয়ং শ্রম-দিবসের দৈর্ঘ্য কিন্তু এখনো নির্দেশিত হয়নি।",
     "এই সঙ্গে স্বয়ং শ্রম-দিবসের দৈর্ঘ্য কিন্তু এখনো নির্দেশিত হয়নি।"),
    ("ক খ রেখাটির প্রসারিত অংশ খ গ প্রতিনিধিত্ব করছে উদ্ধও শ্রমে।",
     "ক খ রেখাটির প্রসারিত অংশ খ গ প্রতিনিধিত্ব করছে উদ্ধও শ্রমে।"),
    ("\"যেহেতু এম-দিবস হচ্ছে ক + গ অর্থাৎ ক গ, সেইহেতু পরিবর্তনীয় রাশি এ গ-র পরিবর্তনের সঙ্গে সঙ্গে এম-দিবসেও পরিবর্তিত হয়।\"",
     "যেহেতু এম-দিবস হচ্ছে ক + গ অর্থাৎ ক গ, সেইহেতু পরিবর্তনীয় রাশি এ গ-র পরিবর্তনের সঙ্গে সঙ্গে এম-দিবসেও পরিবর্তিত হয়।"),
    ("\"যেহেতু কথা হচ্ছে স্থির, সেইহেতু ক খ-র সঙ্গে এ গ-র অনুপাত শব সময়েই হিসাব করা যায়।\"",
     "যেহেতু কথা হচ্ছে স্থির, সেইহেতু ক খ-র সঙ্গে এ গ-র অনুপাত সব সময়েই হিসাব করা যায়।"),
    ("অধিকন্তু যেহেত উদ্ধও শ্রম-সময়।", "অধিকন্তু যেহেত উদ্ধও শ্রম-সময়।"),
    ("\"হারটি নির্ধারণ করে, সেইহেতু এই শেষোক্তটি নির্দেশিত হয় ক -র সঙ্গে খ গ অনুপাতের দ্বারা।\"",
     "হারটি নির্ধারণ করে, সেইহেতু এই শেষোক্তটি নির্দেশিত হয় ক -র সঙ্গে খ গ অনুপাতের দ্বারা।"),
    ("\"তা থেকে এটা বোঝা যেত যে শ্রম-দিবসের দুটি সংগঠনী অংশ, যথা আবশ্যিক শ্রম-সময় উত্তম-সময়, দৈর্ঘ্যে সমান, কিন্তু এটা বোঝা যেত না যে এই দুটি অংশের প্রত্যেকটি কতটা দীর্ঘ।\"",
     "তা থেকে এটা বোঝা যেত যে শ্রম-দিবসের দুটি সংগঠনী অংশ, যথা আবশ্যিক শ্রম-সময় উত্তম-সময়, দৈর্ঘ্যে সমান, কিন্তু এটা বোঝা যেত না যে এই দুটি অংশের প্রত্যেকটি কতটা দীর্ঘ।"),
]

MALAYALAM_FEWSHOT = [
    ("ഇന്നത്തെ കാലഘട്ടത്തിൽ നമുക്ക് ഒഴിച്ചുകൂടാൻ പറ്റാത്ത ഒന്നാണ് സാമൂഹ്യമാധ്യമങ്ങൾ.", "ഇന്നത്തെ കാലഘട്ടത്തിൽ നമുക്ക് ഒഴിച്ചുകൂടാൻ പറ്റാത്ത ഒന്നാണ് സമൂഹമാധ്യമങ്ങൾ."),
    ("വൃദ്ധർ മുതൽ ഒരു വയസുള്ള കുട്ടി വരെ ഇന്ന് ഏതെങ്കിലും രീതിയിലുള്ള സാമൂഹ്യമാധ്യമം ഉപയോഗിക്കുകയോ അതോ അതിന്റെ ഏതെങ്കിലും പ്രത്യാഘാതം അനുഭവിക്കുകയോ ചെയ്തിട്ടുണ്ടാവാം.",
     "വൃദ്ധർ മുതൽ ഒരു വയസുള്ള കുട്ടി വരെ ഇന്ന് ഏതെങ്കിലും രീതിയിലുള്ള സമൂഹമാധ്യമം ഉപയോഗിക്കുകയോ അതോ അതിന്റെ ഏതെങ്കിലും പ്രത്യാഘാതം അനുഭവിക്കുകയോ ചെയ്തിട്ടുണ്ടാവാം."),
    ("\"ഇൻസ്റ്റയിൽ റീൽ കാണുന്നതു മുതൽ യൂട്യൂബിൽ വാർത്ത കേൾക്കുന്നതോ, എന്തിനു മറ്റുള്ളവരുടെ ജീവിതം ആസ്വദിക്കാൻ വരെ ആളുകൾ ഇന്ന് ഇവയെ ഉപയോഗിക്കുന്നു. \"",
     "ഇൻസ്റ്റയിൽ റീൽ കാണുന്നതു മുതൽ യൂട്യൂബിൽ വാർത്ത കേൾക്കുന്നതോ, എന്തിനു മറ്റുള്ളവരുടെ  ജീവിതത്തെക്കുറിച്ച് അറിയാൻ വരെ ആളുകൾ ഇന്ന് ഇവയെ ഉപയോഗിക്കുന്നു."),
    ("\" ഈ പറയുന്നവയൊക്കെ പലർക്കും സന്തോഷം നൽക്കുന്നതാണെങ്കിലും, ഇതിന് നമ്മൾ കൊടുക്കുന്ന വില പലരും അറിയുന്നില്ല എന്നതാണ് സത്യം.\"",
     "ഈ പറയുന്നവയൊക്കെ പലർക്കും സന്തോഷം നൽക്കുന്നതാണെങ്കിലും, ഇതിന് നമ്മൾ കൊടുക്കുന്ന വില എന്താണെന്ന് പലരും അറിയുന്നില്ല എന്നതാണ് സത്യം."),
    ("നമ്മുടെ വിലപ്പെട്ട സമയം 1. . 2. പിന്നെ ശ്രദ്ധചെലുത്താൻ പറ്റുന്ന സമയം. നമ്മുടെ സ്വകാര്യത 3. . ഇതൊക്കെ പലപ്പോഴും നമ്മൾ ചെറിയ ഒരു സന്തോഷത്തിന് വേണ്ടി കളഞ്ഞേക്കാം.",
     "നമ്മുടെ വിലപ്പെട്ട സമയം1. , നമ്മുടെ സ്വകാര്യത 3. , ഇതൊക്കെ പലപ്പോഴും നമ്മൾ ചെറിയ ഒരു സന്തോഷത്തിന് വേണ്ടി കളഞ്ഞേക്കാം."),
    ("ഈ വൻകിട കമ്പനികൾ നമുക്ക് ഇങ്ങനെയൊരു ഉൽപ്പനം 1. വെറുതെ തരണമെങ്കിൽ 2. ഇതിന്റെ ഉൽപ്പനം നമ്മളാണ്.",
     "ഈ വൻകിട കമ്പനികൾ നമുക്ക് ഇങ്ങനെയൊരു ഉൽപ്പനം 1. സൗജന്യമായി  തരണമെങ്കിൽ 2. വാസ്തവത്തിൽ  ഇതിന്റെ ഉൽപ്പനം നമ്മളാണ്."),
    ("പരസ്യക്കമ്പനികൾക്ക് നമ്മൾ എന്തു ചെയ്യുന്നു എന്ന വിവരം കൊടുത്ത് കൃത്യമായ പരസ്യം നമ്മളിലേക്കെത്തിക്കാൻ ഇവയ്ക്ക് കഴിയുന്നുണ്ട്.",
     "നമ്മൾ എന്താണ് ചെയ്യുന്നതെന്ന വിവരം പരസ്യക്കമ്പനികൾക്ക് കൊടുത്തു കൃത്യമായ പരസ്യം നമ്മളിലേക്കെത്തിക്കാൻ ഇവയ്ക്ക് കഴിയുന്നുണ്ട്"),
    ("പിന്നെ 1. ഒരേ പരസ്യം വീണ്ടും വീണ്ടും കാണിച്ച് നമ്മുക്ക് ആവശ്യമില്ലാത്ത ഒരു സാധനം ആവശ്യം ഉള്ളതാണെന്ന് തോന്നിപ്പിച്ച് നമ്മളെ കൊണ്ട് 2. വെറുതെ ഒരു ഉൽപ്പനം വാങ്ങിപ്പിക്കുവാൻ അവയ്ക്ക് കഴിയുന്നുണ്ട്.",
     "പിന്നെ 1. ,  ഒരേ പരസ്യം വീണ്ടും വീണ്ടും കാണിച്ച് നമ്മുക്ക് ആവശ്യമില്ലാത്ത ഒരു സാധനം ആവശ്യം ഉള്ളതാണെന്ന് തോന്നിപ്പിച്ച് നമ്മളെ കൊണ്ട് 2. അത് വാങ്ങിപ്പിക്കുവാൻ അവയ്ക്ക് കഴിയുന്നുണ്ട്."),
    ("കൂടാതെ 1. ഇൻഫ്ലുവൻസേർസ് എന്ന പേരിൽ ഈ മാധ്യമങ്ങളിൽ ജനപ്രീതി ലഭിച്ച 2. ചില 3. ആൾക്കാർ ചില 4. പ്രത്യേകം പരസ്യങ്ങൾ കൊടുക്കും.",
     "കൂടാതെ 1., ഇൻഫ്ലുവൻസേർസ് എന്ന പേരിൽ ഈ മാധ്യമങ്ങളിൽ ജനപ്രീതി ലഭിച്ച  3. ആളുകൾക്ക് ചില 5. പ്രത്യേക പരസ്യങ്ങൾ കൊടുക്കും."),
    ("ഇവർക്കുള്ള ജനപ്രീതി കാരണം ആൾക്കാർ ഇവരെ വിശ്വസിച്ച് വാങ്ങും", "ഇവർക്കുള്ള ജനപ്രീതി കാരണം ആൾക്കാർ ഇവരെ വിശ്വസിച്ച് ഉൽപന്നങ്ങൾ വാങ്ങും"),
]

TAMIL_FEWSHOT = [
    ("எனக்கு சீத்தலை சாத்தனார் இயற்றிய ஐம்பெருங்காப்பியங்களில் ஒன்றான \"மணிமேகலை\" நூலில் வரும் முக்கிய கதை மாந்தரான மணிமேகலைப் பிடிக்கும்.",
     "எனக்கு சீத்தலை சாத்தனார் இயற்றிய ஐம்பெருங்காப்பியங்களில் ஒன்றான \"மணிமேகலை\" நூலில் வரும் முக்கிய கதை மாந்தரான மணிமேகலையைப் பிடிக்கும்."),
    ("அவர் சிலப்பதிகாரத்தில் வரும் கோவலன் மற்றும் மாதவி ஆகியோருக்கு மகனாக பிறந்தார்.",
     "அவர் சிலப்பதிகாரத்தில் வரும் கோவலன் மற்றும் மாதவி ஆகியோருக்கு மகளாக பிறந்தார்."),
    ("முப்பது கண்டங்களைக் கொண்ட மணிமேகலை காவியம் மணிமேகலையின் வாழ்க்கைக் கதையைப் பற்றி எடுத்துரைக்கிறது.",
     "முப்பது காண்டங்களைக் கொண்ட மணிமேகலை காவியம் மணிமேகலையின் வாழ்க்கைக் கதையைப் பற்றி எடுத்துரைக்கிறது."),
    ("மணிமேகலை தனது தாயார் மாதவியால் பௌத்த துறவியாகவே வளர்க்கப்படுவார்.",
     "மணிமேகலை தனது தாயார் மாதவியால் பௌத்த துறவியாகவே வளர்க்கப்படுகிறார்."),
    ("காவேரிப்பட்டின நகரத்தில் ஆண்டு தோறும் இந்திர விழா நடைபெற இருக்கிறது.",
     "காவேரிப்பட்டின நகரத்தில் ஆண்டு தோறும் இந்திர விழா நடைபெறும்."),
    ("அதில் மணிமேகலை பங்கேற்க வேண்டும் என்பது மணிமேகலையால் பாட்டிக்கு விருப்பம்.",
     "அதில் மணிமேகலை பங்கேற்க வேண்டும் என்பது மணிமேகலையின் பாட்டிக்கு விருப்பம்."),
    ("ஏனென்றால் மணிமேகலைக்கோ அதில் பங்குபெற சிறிதும் விருப்பமில்லை.",
     "ஆனால் மணிமேகலைக்கோ அதில் பங்குபெற சிறிதும் விருப்பமில்லை."),
    ("காவேரிப்பட்டினத்தை ஆட்சி செய்யும் அரசனின் மகளான இளவரசன் உதயகுமாரனுக்கு மணிமேகலை மீது விருப்பம்.",
     "காவேரிப்பட்டினத்தை ஆட்சி செய்யும் அரசனின் மகனான இளவரசன் உதயகுமாரனுக்கு மணிமேகலை மீது விருப்பம்."),
    ("மணிமேகலையை எப்படியாவது திருமணம் செய்து கொள்ள வேண்டும் என உதயகுமாரன் ஆசைப்பட்டாள்.",
     "மணிமேகலையை எப்படியாவது திருமணம் செய்து கொள்ள வேண்டும் என உதயகுமாரன் ஆசைப்பட்டான்."),
    ("மணிமேகலையை காண்பதற்காக சென்றாள் உதயகுமாரன்.",
     "மணிமேகலையை காண்பதற்காக சென்றான் உதயகுமாரன்."),
]

TELUGU_FEWSHOT = [
    ("నేను ఇప్పుడు రాయబోయే కథ శ్రీమద్ద భాగవతం లోనిది.", "నేను ఇప్పుడు రాయబోయే కథ శ్రీమద్భాగవతం లోనిది."),
    ("పర్వం ఉదోపాదుడు అనే ఒక వ్యక్తి ఉండేవాడు.", "పూర్వం ఉదోపాదుడు అనే ఒక వ్యక్తి ఉండేవాడు."),
    ("ఈయన స్వంబు మనువు యోక్క కొడుకు.", "ఈయన స్వంబు మనువు యొక్క కొడుకు."),
    ("ఈయనకు ఇద్దరు భర్యలు.", "ఈయనకు ఇద్దరు భార్యలు."),
    ("ఒకరి పేరు సురూచి ఇంక్కోరి పేరు సునీతి.", "ఒకరి పేరు సురూచి ఇంకొకరి పేరు సునీతి."),
    ("సునీతి చాలా మంచది మరియు అన్ని ధర్మాలు తెలుసు.", "సునీతి చాలా మంచిది మరియు అన్ని ధర్మాలు తెలుసు."),
    ("సురూచికి కొంచెం అంకారం ఎక్కువ.", "సురుచికి కొంచెం అహంకారం ఎక్కువ."),
    ("ఉధోపాదుడికి సునీతితో ఒక కొడుకు పుట్టాడు. అతని పెరు ఉత్తముడు.", "ఉధోపాదుడికి సునీతితో ఒక కొడుకు పుట్టాడు. అతని పేరు ఉత్తముడు."),
    ("సురుచికి పుట్టిన కొడుకు పేరు దవుడు.", "సురుచికి పుట్టిన కొడుకు పేరు ధృవుడు."),
    ("\"ఉదోపాదుడికి సురూచి మీద మక్కువ ఎక్కువ(,) కాబట్టి తను ఏమి చెప్పిన కాదు అనే వాడు కాదు.\"",
     "ఉదోపాదుడికి సురూచి మీద మక్కువ ఎక్కువ, కాబట్టి తను ఏమి చెప్పిన కాదు అనే వాడు కాదు."),
]
SYSTEM_PROMPT = """You are a Grammatical Error Correction (GEC) assistant for low-resource Indian languages.
Your job: correct only grammar, spelling, spacing, matras/diacritics, punctuation, and light word-form errors.
Do NOT translate. Preserve the meaning, script, and style of the input language.
Return ONLY the corrected sentence with no quotes, no labels, no extra text.
If the input is already correct, return it unchanged."""

### ==========================================================
###  Few-shot builder
### ==========================================================
def build_fewshot(lang: str):
    msgs = [{"role": "system", "content": SYSTEM_PROMPT}]

    if lang == "hindi":
        examples = HINDI_FEWSHOT
    elif lang == "bangla":
        examples = BANGLA_FEWSHOT
    elif lang == "malayalam":
        examples = MALAYALAM_FEWSHOT
    elif lang == "tamil":
        examples = TAMIL_FEWSHOT
    elif lang == "telugu":
        examples = TELUGU_FEWSHOT
    else:
        examples = []

    for inp, out in examples:
        msgs.append({"role": "user", "content": f"INPUT:\n{inp}\n\nOUTPUT:"})
        msgs.append({"role": "assistant", "content": out})

    return msgs


### ==========================================================
###  Llama API Call
### ==========================================================
def call_llama(messages, api_key):
    invoke_url = "https://integrate.api.nvidia.com/v1/chat/completions"

    payload = {
        "model": "meta/llama-4-maverick-17b-128e-instruct",
        "messages": messages,
        "max_tokens": 256,
        "temperature": 0.2,
        "top_p": 1.0,
        "stream": False
    }

    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }

    try:
        resp = requests.post(invoke_url, headers=headers, json=payload, timeout=120)
        r = resp.json()
        return r["choices"][0]["message"]["content"].strip()
    except Exception as e:
        print(f"[ERROR] Llama API failed: {e}", file=sys.stderr)
        return None


### ==========================================================
###  Main
### ==========================================================
def main():
    parser = argparse.ArgumentParser(description="Few-shot GEC inference using NVIDIA NIM Llama-4")
    parser.add_argument("--lang", type=str, required=True)
    parser.add_argument("--data_root", type=str, default="test")
    parser.add_argument("--limit", type=int, default=-1)
    parser.add_argument("--rpm", type=int, default=35)
    args = parser.parse_args()

    lang = args.lang.lower()
    if lang not in SUPPORTED_LANGS:
        print(f"[ERROR] Unsupported language: {lang}", file=sys.stderr)
        sys.exit(1)

    api_key = os.environ.get("NVIDIA_API_KEY")
    if not api_key:
        print("[ERROR] NVIDIA_API_KEY not exported!", file=sys.stderr)
        sys.exit(1)

    csv_path = os.path.join(args.data_root, f"{lang}.csv")
    if not os.path.isfile(csv_path):
        print(f"[ERROR] Missing file: {csv_path}", file=sys.stderr)
        sys.exit(1)

    df = pd.read_csv(csv_path)
    if "Input sentence" not in df.columns:
        print("[ERROR] CSV missing 'Input sentence'", file=sys.stderr)
        sys.exit(1)

    if args.limit > 0:
        df = df.head(args.limit)

    out_dir = os.path.join("infer_llama_fewshot", lang)
    os.makedirs(out_dir, exist_ok=True)
    out_csv = os.path.join(out_dir, "predictions.csv")

    base_messages = build_fewshot(lang)
    inputs = df["Input sentence"].astype(str).tolist()
    preds = []

    sleep_time = max(60.0 / args.rpm, 1.8)

    print(f"[INFO] Running FEW-SHOT LLAMA inference for {lang}…")
    for sent in tqdm(inputs):
        messages = list(base_messages) + [
            {"role": "user", "content": f"INPUT:\n{sent}\n\nOUTPUT:"}
        ]

        output = call_llama(messages, api_key)
        if output is None:
            output = sent

        preds.append(output)
        time.sleep(sleep_time)

    pd.DataFrame({
        "Input sentence": inputs,
        "Output sentence": preds
    }).to_csv(out_csv, index=False, encoding="utf-8")

    print(f"[OK] Saved few-shot predictions to: {out_csv}")


if __name__ == "__main__":
    main()
